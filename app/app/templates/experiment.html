<!--
PostgreSQL Statistics Estimator - Experiment Setup Page (Refactored)

This template has been refactored to use modular components for better
maintainability and reusability. Large sections have been extracted into
separate partial templates and JavaScript has been moved to external files.

Components Used:
- _partials/experiment_form.html: Main experiment configuration form
- static/js/experiment-form.js: Form functionality and configuration management

Author: Generated by Assistant
Created: 2024 (Refactored from original large template)
-->

{% extends "base.html" %}

{% block title %}Run Experiment - {{ super() }}{% endblock %}

{% block content %}
<div class="container">
    <!-- Page Header -->
    <div class="d-flex align-items-center justify-content-between mb-4">
        <h1 class="h2 mb-0">
            <i class="bi bi-play-circle me-2"></i>
            Run Experiment
        </h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="/">Home</a></li>
                <li class="breadcrumb-item active">Run Experiment</li>
            </ol>
        </nav>
    </div>

    <!-- Main Configuration Card -->
    <div class="card shadow-sm">
        <div class="card-header bg-white py-3">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0 flex-grow-1">Configure Experiment</h5>
            </div>
        </div>
        <div class="card-body">
            <!-- Include the experiment form partial -->
            {% include "_partials/experiment_form.html" %}
        </div>
    </div>

    <!-- Experiment Container for Progress Display -->
    <div id="experiment-container" class="mt-4">
        {% if experiment_id %}
        <div id="experiment-result">
            <div class="alert alert-info">
                <strong>Experiment Started!</strong> Running {{ iterations }} iterations with {{ stats_source }}...<br>
                <span class="text-muted">Dump: {{ dump_file }} | Query: {{ query_file }}</span>
            </div>
            <div class="progress mb-3">
                <div class="progress-bar" id="progress-bar-{{ experiment_id }}" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0"
                    aria-valuemax="100">0%</div>
            </div>
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Experiment Progress</h5>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-secondary active"
                            onclick="setLogLevel('info', this)">Info</button>
                        <button type="button" class="btn btn-outline-warning"
                            onclick="setLogLevel('warning', this)">Warnings</button>
                        <button type="button" class="btn btn-outline-danger"
                            onclick="setLogLevel('error', this)">Errors</button>
                    </div>
                </div>
                <div class="card-body">
                    <pre id="progress-log-{{ experiment_id }}" style="height: 300px; overflow-y: auto;" class="mb-0 bg-light p-3"></pre>
                    <div hx-sse="connect:/experiment/stream/{{ experiment_id }}" style="display: none; ">
                        <div hx-sse="swap:message" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

</div>

<!-- Settings Editor Modal -->
<div class="modal fade" id="settingsEditorModal" tabindex="-1" aria-labelledby="settingsEditorModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="settingsEditorModalLabel">
                    <i class="bi bi-sliders me-2"></i>
                    Settings Editor
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="mb-3">
                            <label for="settings-yaml-editor" class="form-label">
                                <i class="bi bi-file-earmark-code me-1"></i>
                                YAML Settings
                            </label>
                            <textarea class="form-control" id="settings-yaml-editor" rows="20"
                                style="font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;"></textarea>
                            <div class="form-text">Edit the runtime settings in YAML format</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Settings Info
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <strong>Settings:</strong> <span id="settings-name">-</span>
                                </div>
                                <div class="mb-3">
                                    <strong>Status:</strong> <span id="settings-status"
                                        class="badge bg-secondary">Ready</span>
                                </div>
                                <div class="alert alert-info">
                                    <small>
                                        <i class="bi bi-lightbulb me-1"></i>
                                        <strong>Tip:</strong> Settings control runtime behavior like timeouts and memory usage.
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="card mt-3">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-list-check me-1"></i>
                                    Runtime Settings
                                </h6>
                            </div>
                            <div class="card-body">
                                <ul class="list-unstyled mb-0 small">
                                    <li><code>analyze_verbose</code> - Enable verbose analyze output</li>
                                    <li><code>analyze_timeout_seconds</code> - Timeout for operations</li>
                                    <li><code>clear_caches</code> - Clear database caches</li>
                                    <li><code>reset_counters</code> - Reset statistics counters</li>
                                    <li><code>work_mem</code> - Memory for operations</li>
                                    <li><code>maintenance_work_mem</code> - Memory for maintenance</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-outline-primary" onclick="resetSettings()">
                    <i class="bi bi-arrow-clockwise me-1"></i>
                    Reset to Original
                </button>
                <button type="button" class="btn btn-primary" onclick="saveSettings()">
                    <i class="bi bi-check2 me-1"></i>
                    Save Settings
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Configuration Editor Modal -->
<div class="modal fade" id="configEditorModal" tabindex="-1" aria-labelledby="configEditorModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="configEditorModalLabel">
                    <i class="bi bi-gear me-2"></i>
                    Configuration Editor
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="mb-3">
                            <label for="config-yaml-editor" class="form-label">
                                <i class="bi bi-file-earmark-code me-1"></i>
                                YAML Configuration
                            </label>
                            <textarea class="form-control" id="config-yaml-editor" rows="20"
                                style="font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;"></textarea>
                            <div class="form-text">Edit the configuration data in YAML format</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Configuration Info
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <strong>Source:</strong> <span id="config-source-name">-</span>
                                </div>
                                <div class="mb-2">
                                    <strong>Original Config:</strong> <span id="config-original-name">-</span>
                                </div>
                                <div class="mb-3">
                                    <strong>Status:</strong> <span id="config-status"
                                        class="badge bg-secondary">Ready</span>
                                </div>
                                <div class="alert alert-info">
                                    <small>
                                        <i class="bi bi-lightbulb me-1"></i>
                                        <strong>Tip:</strong> Configuration data is passed to the statistics source for processing.
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="card mt-3">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-list-check me-1"></i>
                                    Configuration Data
                                </h6>
                            </div>
                            <div class="card-body">
                                <ul class="list-unstyled mb-0 small">
                                    <li><code>name</code> - Configuration name</li>
                                    <li><code>description</code> - Configuration description</li>
                                    <li><code>message</code> - Data message for stats source</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-outline-primary" onclick="resetConfiguration()">
                    <i class="bi bi-arrow-clockwise me-1"></i>
                    Reset to Original
                </button>
                <button type="button" class="btn btn-primary" onclick="saveConfiguration()">
                    <i class="bi bi-check2 me-1"></i>
                    Save Configuration
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- External JavaScript for experiment form functionality -->
<script src="{{ url_for('static', path='/js/experiment-form.js') }}"></script>

<!-- Debugging script for HTMX and EventSource -->
<script>
// Enable HTMX logging for debugging
htmx.logAll();

// Add extra debugging for EventSource issues
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, setting up debugging...');
    
    // Override console methods to also display in page for mobile debugging
    const originalLog = console.log;
    const originalError = console.error;
    
    function createDebugElement() {
        const debugDiv = document.createElement('div');
        debugDiv.id = 'debug-output';
        debugDiv.style.cssText = `
            position: fixed; 
            bottom: 10px; 
            right: 10px; 
            width: 300px; 
            max-height: 200px; 
            overflow-y: auto; 
            background: rgba(0,0,0,0.8); 
            color: white; 
            padding: 10px; 
            font-size: 10px; 
            font-family: monospace; 
            border-radius: 5px; 
            z-index: 9999;
            display: none;
        `;
        document.body.appendChild(debugDiv);
        return debugDiv;
    }
    
    const debugDiv = createDebugElement();
    
    // Show/hide debug panel with Ctrl+D
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'd') {
            e.preventDefault();
            debugDiv.style.display = debugDiv.style.display === 'none' ? 'block' : 'none';
        }
    });
    
    function addToDebug(message, type = 'log') {
        const timestamp = new Date().toLocaleTimeString();
        const entry = document.createElement('div');
        entry.style.color = type === 'error' ? '#ff6b6b' : '#4ecdc4';
        entry.textContent = `[${timestamp}] ${message}`;
        debugDiv.appendChild(entry);
        debugDiv.scrollTop = debugDiv.scrollHeight;
        
        // Keep only last 50 entries
        while (debugDiv.children.length > 50) {
            debugDiv.removeChild(debugDiv.firstChild);
        }
    }
    
    console.log = function(...args) {
        addToDebug(args.join(' '), 'log');
        originalLog.apply(console, args);
    };
    
    console.error = function(...args) {
        addToDebug(args.join(' '), 'error');
        originalError.apply(console, args);
    };
    
    console.log('Debug panel initialized. Press Ctrl+D to toggle.');
});
</script>
{% endblock %}