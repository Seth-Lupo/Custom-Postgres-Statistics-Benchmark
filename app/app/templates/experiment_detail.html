{% extends "base.html" %}

{% block title %}Experiment {{ experiment.id }} - {{ super() }}{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex align-items-center justify-content-between mb-4">
        <div>
            <h1 class="h2 mb-0">
                <i class="bi bi-graph-up me-2"></i>
                ({{ experiment.name }})
                <i style="font-size: 0.5em;">Experiment {{ experiment.id }}</i>
            </h1>
            <p class="text-muted mb-0">Detailed results for experiment using {{ experiment.stats_source }}</p>
        </div>
        <div class="d-flex align-items-center">
            {% if experiment.experiment_logs %}
            <button type="button" class="btn btn-outline-info me-3" onclick="showExperimentLogs()">
                <i class="bi bi-journal-text me-1"></i>
                View Logs
            </button>
            {% endif %}
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="/">Home</a></li>
                    <li class="breadcrumb-item"><a href="/results">Results</a></li>
                    <li class="breadcrumb-item active">Experiment {{ experiment.id }}</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="rounded-circle bg-primary bg-opacity-10 p-3 me-3">
                            <i class="bi bi-database text-primary"></i>
                        </div>
                        <div>
                            <h6 class="card-subtitle text-muted mb-1">Statistics Source</h6>
                            <h5 class="card-title mb-0">{{ experiment.stats_source }}</h5>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="rounded-circle bg-info bg-opacity-10 p-3 me-3">
                            <i class="bi bi-arrow-repeat text-info"></i>
                        </div>
                        <div>
                            <h6 class="card-subtitle text-muted mb-1">Total Iterations</h6>
                            <h5 class="card-title mb-0">{{ experiment.iterations }}</h5>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="rounded-circle bg-success bg-opacity-10 p-3 me-3">
                            <i class="bi bi-clock text-success"></i>
                        </div>
                        <div>
                            <h6 class="card-subtitle text-muted mb-1">Average Time</h6>
                            <h5 class="card-title mb-0">
                                {% if experiment.avg_time %}
                                {{ "%.6f"|format(experiment.avg_time) }}s
                                {% else %}
                                -
                                {% endif %}
                            </h5>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="rounded-circle bg-warning bg-opacity-10 p-3 me-3">
                            <i class="bi bi-distribute-vertical text-warning"></i>
                        </div>
                        <div>
                            <h6 class="card-subtitle text-muted mb-1">Standard Deviation</h6>
                            <h5 class="card-title mb-0">
                                {% if experiment.stddev_time %}
                                {{ "%.6f"|format(experiment.stddev_time) }}s
                                {% else %}
                                -
                                {% endif %}
                            </h5>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Experiment Behavior Configuration -->
    <div class="row g-4 mb-4">
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="rounded-circle bg-purple bg-opacity-10 p-3 me-3" style="background-color: rgba(102, 16, 242, 0.1) !important;">
                            <i class="bi bi-bootstrap-reboot" style="color: #6610f2;"></i>
                        </div>
                        <div>
                            <h6 class="card-subtitle text-muted mb-1">Statistics Reset Strategy</h6>
                            <h5 class="card-title mb-0">
                                {% if experiment.stats_reset_strategy == 'once' %}
                                <span class="badge bg-info">
                                    <i class="bi bi-arrow-down-circle me-1"></i>
                                    Once Before All Trials
                                </span>
                                {% else %}
                                <span class="badge bg-warning">
                                    <i class="bi bi-arrow-repeat me-1"></i>
                                    Reset Per Trial
                                </span>
                                {% endif %}
                            </h5>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="rounded-circle bg-teal bg-opacity-10 p-3 me-3" style="background-color: rgba(13, 202, 240, 0.1) !important;">
                            <i class="bi bi-database-exclamation" style="color: #0dcaf0;"></i>
                        </div>
                        <div>
                            <h6 class="card-subtitle text-muted mb-1">Transaction Handling</h6>
                            <h5 class="card-title mb-0">
                                {% if experiment.transaction_handling == 'rollback' %}
                                <span class="badge bg-success">
                                    <i class="bi bi-arrow-clockwise me-1"></i>
                                    Rollback Changes
                                </span>
                                {% else %}
                                <span class="badge bg-warning">
                                    <i class="bi bi-save me-1"></i>
                                    Persist Changes
                                </span>
                                {% endif %}
                            </h5>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Exit Status and Additional Stats -->
    <div class="row g-4 mb-4">
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="rounded-circle {% if experiment.exit_status == 'SUCCESS' %}bg-success{% elif experiment.exit_status == 'FAILURE' %}bg-danger{% else %}bg-secondary{% endif %} bg-opacity-10 p-3 me-3">
                            {% if experiment.exit_status == 'SUCCESS' %}
                            <i class="bi bi-check-circle text-success"></i>
                            {% elif experiment.exit_status == 'FAILURE' %}
                            <i class="bi bi-x-circle text-danger"></i>
                            {% else %}
                            <i class="bi bi-clock text-secondary"></i>
                            {% endif %}
                        </div>
                        <div>
                            <h6 class="card-subtitle text-muted mb-1">Exit Status</h6>
                            <h5 class="card-title mb-0">
                                {% if experiment.exit_status == 'SUCCESS' %}
                                <span class="badge bg-success">SUCCESS</span>
                                {% elif experiment.exit_status == 'FAILURE' %}
                                <span class="badge bg-danger">FAILURE</span>
                                {% elif experiment.exit_status == 'RUNNING' %}
                                <span class="badge bg-primary">RUNNING</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ experiment.exit_status or 'PENDING' }}</span>
                                {% endif %}
                            </h5>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="rounded-circle bg-info bg-opacity-10 p-3 me-3">
                            <i class="bi bi-calendar3 text-info"></i>
                        </div>
                        <div>
                            <h6 class="card-subtitle text-muted mb-1">Created At</h6>
                            <h5 class="card-title mb-0">{{ experiment.created_at.strftime('%Y-%m-%d %H:%M') }}</h5>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if experiment.config_name or experiment.config_yaml %}
    <!-- Configuration Section -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-white py-3">
            <div class="d-flex align-items-center">
                <i class="bi bi-gear me-2 text-primary"></i>
                <h5 class="card-title mb-0">Configuration Used</h5>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label small text-muted">Configuration Name</label>
                        <div class="p-2 bg-light rounded">
                            <span class="badge bg-primary me-2">{{ experiment.config_name or 'default' }}</span>
                            <span class="text-muted">{{ experiment.stats_source }}</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label small text-muted">Status</label>
                        <div class="p-2 bg-light rounded">
                            {% if experiment.config_yaml %}
                                <span class="badge bg-success">
                                    <i class="bi bi-pencil-square me-1"></i>
                                    Custom Configuration
                                </span>
                            {% else %}
                                <span class="badge bg-secondary">
                                    <i class="bi bi-gear me-1"></i>
                                    Standard Configuration
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            {% if experiment.config_yaml %}
            <div class="mt-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <label class="form-label small text-muted mb-0">YAML Configuration</label>
                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#configYamlCollapse" aria-expanded="false" aria-controls="configYamlCollapse">
                        <i class="bi bi-eye me-1"></i>
                        View YAML
                    </button>
                </div>
                <div class="collapse" id="configYamlCollapse">
                    <pre class="bg-light p-3 rounded small"><code class="language-yaml">{{ experiment.config_yaml }}</code></pre>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% if experiment.experiment_logs %}
    <!-- Experiment Logs Section -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-white py-3">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <i class="bi bi-journal-text me-2 text-primary"></i>
                    <h5 class="card-title mb-0">Experiment Logs</h5>
                </div>
                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#logsCollapse" aria-expanded="false" aria-controls="logsCollapse">
                    <i class="bi bi-eye me-1"></i>
                    View Logs
                </button>
            </div>
        </div>
        <div class="collapse" id="logsCollapse">
            <div class="card-body">
                <pre class="bg-dark text-light p-3 rounded small" style="max-height: 400px; overflow-y: auto;"><code>{{ experiment.experiment_logs }}</code></pre>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Query and Charts -->
    <div class="row g-4">
        <div class="col-md-5">
            <div class="card shadow-sm">
                <div class="card-header bg-white py-3">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-code-square me-2 text-primary"></i>
                        <h5 class="card-title mb-0">Query</h5>
                    </div>
                </div>
                <div class="card-body">
                    <pre class="bg-light p-3 rounded mb-0"><code class="language-sql">{{ experiment.query }}</code></pre>
                </div>
            </div>
        </div>
        
        <div class="col-md-7">
            <div class="card shadow-sm">
                <div class="card-header bg-white py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-graph-up me-2 text-primary"></i>
                            <h5 class="card-title mb-0">Visualization</h5>
                        </div>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-sm btn-outline-primary active" 
                                    hx-get="/results/{{ experiment.id }}/chart?chart_type=bar" 
                                    hx-target="#chart-container">
                                <i class="bi bi-bar-chart me-1"></i>
                                Bar Chart
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary" 
                                    hx-get="/results/{{ experiment.id }}/chart?chart_type=line" 
                                    hx-target="#chart-container">
                                <i class="bi bi-graph-up me-1"></i>
                                Line Chart
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary" 
                                    hx-get="/results/{{ experiment.id }}/chart?chart_type=histogram" 
                                    hx-target="#chart-container">
                                <i class="bi bi-distribute-vertical me-1"></i>
                                Histogram
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="chart-container" class="chart-container" 
                         hx-get="/results/{{ experiment.id }}/chart?type=bar" 
                         hx-trigger="load">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="text-muted mt-2">Loading chart...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Trial Results Table -->
    <div class="card shadow-sm mt-4">
        <div class="card-header bg-white py-3">
            <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <i class="bi bi-table me-2 text-primary"></i>
                    <h5 class="card-title mb-0">Individual Trial Results</h5>
                </div>
                <div class="d-flex align-items-center">
                    <span class="badge bg-success me-2">Fast: < 90%</span>
                    <span class="badge bg-secondary me-2">Average: 90-110%</span>
                    <span class="badge bg-warning">Slow: > 110%</span>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="border-0">Trial #</th>
                            <th class="border-0">Execution Time (s)</th>
                            <th class="border-0">Cost Estimate</th>
                            <th class="border-0">Relative Performance</th>
                            <th class="border-0">Statistics</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for trial in trials %}
                        {% set avg_time = experiment.avg_time or 0 %}
                        {% set performance_ratio = (trial.execution_time / avg_time) if avg_time > 0 else 1 %}
                        <tr>
                            <td class="align-middle">
                                <span class="badge bg-secondary">#{{ trial.run_index }}</span>
                            </td>
                            <td class="align-middle">
                                <i class="bi bi-clock me-1"></i>
                                {{ "%.6f"|format(trial.execution_time) }}
                            </td>
                            <td class="align-middle">
                                {% if trial.cost_estimate %}
                                <i class="bi bi-calculator me-1"></i>
                                {{ "%.2f"|format(trial.cost_estimate) }}
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="align-middle">
                                {% if performance_ratio < 0.9 %}
                                <span class="badge bg-success">
                                    <i class="bi bi-lightning me-1"></i>
                                    {{ "%.1f"|format(performance_ratio * 100) }}% (Fast)
                                </span>
                                {% elif performance_ratio > 1.1 %}
                                <span class="badge bg-warning">
                                    <i class="bi bi-exclamation-triangle me-1"></i>
                                    {{ "%.1f"|format(performance_ratio * 100) }}% (Slow)
                                </span>
                                {% else %}
                                <span class="badge bg-secondary">
                                    <i class="bi bi-arrow-left-right me-1"></i>
                                    {{ "%.1f"|format(performance_ratio * 100) }}% (Average)
                                </span>
                                {% endif %}
                            </td>
                            <td class="align-middle">
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-info btn-sm" 
                                            onclick="showStatistics({{ experiment.id }}, {{ trial.id }}, 'pg_stats')"
                                            title="View pg_stats snapshot">
                                        <i class="bi bi-table me-1"></i>
                                        pg_stats
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" 
                                            onclick="showStatistics({{ experiment.id }}, {{ trial.id }}, 'pg_statistic')"
                                            title="View pg_statistic snapshot">
                                        <i class="bi bi-database me-1"></i>
                                        pg_statistic
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Statistics Modal -->
    <div class="modal fade" id="statisticsModal" tabindex="-1" aria-labelledby="statisticsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="statisticsModalLabel">
                        <i class="bi bi-table me-2"></i>
                        <span id="statisticsModalTitle">Statistics Snapshot</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="statisticsLoadingSpinner" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="text-muted mt-2">Loading statistics data...</p>
                    </div>
                    <div id="statisticsContent" style="display: none;">
                        <div class="mb-3">
                            <input type="text" class="form-control" id="statisticsSearch" placeholder="Search in table...">
                        </div>
                        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                            <table class="table table-striped table-hover" id="statisticsTable">
                                <thead class="table-dark sticky-top">
                                    <tr id="statisticsTableHeader">
                                        <!-- Headers will be populated dynamically -->
                                    </tr>
                                </thead>
                                <tbody id="statisticsTableBody">
                                    <!-- Data will be populated dynamically -->
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">
                                <span id="statisticsRowCount">0</span> rows displayed
                            </small>
                        </div>
                    </div>
                    <div id="statisticsError" style="display: none;">
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <span id="statisticsErrorMessage">Failed to load statistics data</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="exportStatistics()">
                        <i class="bi bi-download me-1"></i>
                        Export CSV
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Experiment Logs Modal -->
    <div class="modal fade" id="experimentLogsModal" tabindex="-1" aria-labelledby="experimentLogsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="experimentLogsModalLabel">
                        <i class="bi bi-journal-text me-2"></i>
                        Experiment Logs - {{ experiment.name }}
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-secondary active" onclick="setLogsLogLevel('info', this)">Info</button>
                            <button type="button" class="btn btn-outline-warning" onclick="setLogsLogLevel('warning', this)">Warnings</button>
                            <button type="button" class="btn btn-outline-danger" onclick="setLogsLogLevel('error', this)">Errors</button>
                        </div>
                        <div>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="downloadLogs()">
                                <i class="bi bi-download me-1"></i>
                                Download Logs
                            </button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body p-0">
                            <pre id="experimentLogsContent" class="mb-0 bg-dark text-light p-3" style="height: 500px; overflow-y: auto; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace; font-size: 0.875rem; line-height: 1.4;">{{ experiment.experiment_logs or 'No logs available' }}</pre>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="d-flex justify-content-between align-items-center mt-4">
        <a href="/results" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>
            Back to Results
        </a>
        <a href="/experiment" class="btn btn-primary">
            <i class="bi bi-plus-lg me-1"></i>
            Run New Experiment
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentStatisticsData = [];
let currentStatisticsColumns = [];

// Handle chart button active state
document.addEventListener('htmx:afterSwap', function(event) {
    if (event.target.id === 'chart-container') {
        // Update active button state
        const buttons = document.querySelectorAll('.btn-group .btn');
        buttons.forEach(btn => {
            btn.classList.remove('active', 'btn-primary');
            btn.classList.add('btn-outline-primary');
            if (btn === event.detail.elt) {
                btn.classList.remove('btn-outline-primary');
                btn.classList.add('active', 'btn-primary');
            }
        });
    }
});

// Add loading indicator for chart changes
document.addEventListener('htmx:beforeRequest', function(event) {
    if (event.target.id === 'chart-container') {
        event.target.innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="text-muted mt-2">Loading chart...</p>
            </div>
        `;
    }
});

// Statistics modal functions
function showStatistics(experimentId, trialId, type) {
    // Show loading state
    document.getElementById('statisticsLoadingSpinner').style.display = 'block';
    document.getElementById('statisticsContent').style.display = 'none';
    document.getElementById('statisticsError').style.display = 'none';
    
    // Update modal title
    const title = type === 'pg_stats' ? 'pg_stats Snapshot' : 'pg_statistic Snapshot';
    document.getElementById('statisticsModalTitle').textContent = title;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('statisticsModal'));
    modal.show();
    
    // Fetch data
    const url = `/results/${experimentId}/trial/${trialId}/${type}`;
    fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            currentStatisticsData = data.data || [];
            currentStatisticsColumns = data.columns || [];
            
            // Hide loading, show content
            document.getElementById('statisticsLoadingSpinner').style.display = 'none';
            document.getElementById('statisticsContent').style.display = 'block';
            
            // Update title with data info
            document.getElementById('statisticsModalTitle').textContent = data.title || title;
            
            // Populate table
            populateStatisticsTable(currentStatisticsData, currentStatisticsColumns);
        })
        .catch(error => {
            console.error('Error loading statistics:', error);
            
            // Hide loading, show error
            document.getElementById('statisticsLoadingSpinner').style.display = 'none';
            document.getElementById('statisticsError').style.display = 'block';
            document.getElementById('statisticsErrorMessage').textContent = 'Failed to load statistics data: ' + error.message;
        });
}

function populateStatisticsTable(data, columns) {
    const headerRow = document.getElementById('statisticsTableHeader');
    const tbody = document.getElementById('statisticsTableBody');
    
    // Clear existing content
    headerRow.innerHTML = '';
    tbody.innerHTML = '';
    
    if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="100%" class="text-center text-muted py-4">No data available</td></tr>';
        document.getElementById('statisticsRowCount').textContent = '0';
        return;
    }
    
    // Create header
    columns.forEach(column => {
        const th = document.createElement('th');
        th.textContent = column.label;
        th.className = 'border-0 text-nowrap';
        headerRow.appendChild(th);
    });
    
    // Create rows
    data.forEach(row => {
        const tr = document.createElement('tr');
        columns.forEach(column => {
            const td = document.createElement('td');
            const value = row[column.key];
            
            if (value === null || value === undefined) {
                td.innerHTML = '<span class="text-muted">-</span>';
            } else {
                // Truncate long values for display
                const displayValue = String(value);
                if (displayValue.length > 50) {
                    td.innerHTML = `<span title="${displayValue.replace(/"/g, '&quot;')}">${displayValue.substring(0, 47)}...</span>`;
                } else {
                    td.textContent = displayValue;
                }
            }
            td.className = 'align-middle';
            tr.appendChild(td);
        });
        tbody.appendChild(tr);
    });
    
    // Update row count
    document.getElementById('statisticsRowCount').textContent = data.length;
}

// Search functionality
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('statisticsSearch');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const tbody = document.getElementById('statisticsTableBody');
            const rows = tbody.querySelectorAll('tr');
            
            let visibleCount = 0;
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Update row count
            document.getElementById('statisticsRowCount').textContent = visibleCount;
        });
    }
});

// Export functionality
function exportStatistics() {
    if (!currentStatisticsData || currentStatisticsData.length === 0) {
        alert('No data to export');
        return;
    }
    
    // Create CSV content
    const headers = currentStatisticsColumns.map(col => col.label);
    const csvContent = [
        headers.join(','),
        ...currentStatisticsData.map(row => 
            currentStatisticsColumns.map(col => {
                const value = row[col.key];
                if (value === null || value === undefined) return '';
                // Escape commas and quotes
                const stringValue = String(value);
                if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n')) {
                    return '"' + stringValue.replace(/"/g, '""') + '"';
                }
                return stringValue;
            }).join(',')
        )
    ].join('\n');
    
    // Download file
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    
    const title = document.getElementById('statisticsModalTitle').textContent;
    link.download = `${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.csv`;
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Experiment Logs Modal Functions
let currentLogsLogLevel = 'info';
let originalLogsContent = '';

function showExperimentLogs() {
    // Store original logs content
    const logsElement = document.getElementById('experimentLogsContent');
    originalLogsContent = logsElement.textContent;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('experimentLogsModal'));
    modal.show();
    
    // Apply current filter
    filterLogsByLevel();
}

function setLogsLogLevel(level, button) {
    currentLogsLogLevel = level;
    
    // Update button states
    button.parentElement.querySelectorAll('button').forEach(btn => {
        btn.classList.remove('active', 'btn-secondary');
        btn.classList.add('btn-outline-secondary');
    });
    button.classList.remove('btn-outline-secondary');
    button.classList.add('active', 'btn-secondary');
    
    // Filter and display logs
    filterLogsByLevel();
}

function filterLogsByLevel() {
    const logsElement = document.getElementById('experimentLogsContent');
    const lines = originalLogsContent.split('\n');
    
    let filteredLines = lines;
    
    if (currentLogsLogLevel === 'error') {
        filteredLines = lines.filter(line => line.includes('❌') || line.includes('ERROR'));
    } else if (currentLogsLogLevel === 'warning') {
        filteredLines = lines.filter(line => 
            line.includes('⚠️') || line.includes('❌') || 
            line.includes('WARNING') || line.includes('ERROR')
        );
    }
    // 'info' shows all lines
    
    logsElement.textContent = filteredLines.join('\n');
    logsElement.scrollTop = logsElement.scrollHeight;
}

function downloadLogs() {
    const logsContent = document.getElementById('experimentLogsContent').textContent;
    
    if (!logsContent || logsContent.trim() === 'No logs available') {
        alert('No logs to download');
        return;
    }
    
    // Create and download file
    const blob = new Blob([logsContent], { type: 'text/plain;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    
    const experimentName = '{{ experiment.name }}';
    const experimentId = '{{ experiment.id }}';
    link.download = `experiment_${experimentId}_${experimentName.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_logs.txt`;
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
</script>

<style>
.card {
    border: none;
    transition: all 0.3s ease;
}

.card:hover {
    transform: translateY(-2px);
}

.chart-container {
    min-height: 400px;
    background: white;
}

pre {
    margin: 0;
    background: #f8f9fa;
    border-radius: 0.5rem;
    max-height: 300px;
    overflow-y: auto;
}

code {
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
    font-size: 0.875rem;
}

.table th {
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.5px;
}

.badge {
    padding: 0.5em 0.75em;
    font-weight: 500;
}

.btn-group .btn {
    border-radius: 0.375rem;
    margin: 0 0.25rem;
}

.btn-group .btn:first-child {
    margin-left: 0;
}

.btn-group .btn:last-child {
    margin-right: 0;
}

.breadcrumb {
    background: transparent;
    margin: 0;
    padding: 0;
}

.breadcrumb-item a {
    color: #6c757d;
    text-decoration: none;
}

.breadcrumb-item a:hover {
    color: #0d6efd;
    text-decoration: underline;
}

/* Smooth transitions */
.btn {
    transition: all 0.2s ease;
}

.btn:hover {
    transform: translateY(-1px);
}

/* Stats cards */
.rounded-circle {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.rounded-circle i {
    font-size: 1.25rem;
}

/* Statistics modal styling */
.modal-xl {
    max-width: 95%;
}

#statisticsTable {
    font-size: 0.875rem;
}

#statisticsTable th {
    position: sticky;
    top: 0;
    z-index: 10;
    background-color: #212529 !important;
}

#statisticsTable td {
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

#statisticsTable td:hover {
    overflow: visible;
    white-space: normal;
    word-wrap: break-word;
}

.btn-group-sm .btn {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}

#statisticsSearch {
    max-width: 300px;
}

.table-responsive {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
}

/* Experiment logs modal styling */
#experimentLogsContent {
    background-color: #212529 !important;
    color: #ffffff !important;
    border-radius: 0.375rem;
    max-height: 500px;
    white-space: pre-wrap;
    word-wrap: break-word;
}

#experimentLogsContent::-webkit-scrollbar {
    width: 8px;
}

#experimentLogsContent::-webkit-scrollbar-track {
    background: #343a40;
}

#experimentLogsContent::-webkit-scrollbar-thumb {
    background: #6c757d;
    border-radius: 4px;
}

#experimentLogsContent::-webkit-scrollbar-thumb:hover {
    background: #868e96;
}
</style>
{% endblock %} 